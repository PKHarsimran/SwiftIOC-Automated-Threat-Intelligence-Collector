name: Collect â€“ SwiftIOC

on:
  workflow_dispatch:
    inputs:
      window_hours:
        description: "Lookback hours"
        required: false
        default: "48"
      urlhaus_status:
        description: "Filter URLhaus by status (any|online|offline)"
        required: false
        default: "online"
  schedule:
    # Every 4 hours (adjust as you like)
    - cron: "0 */4 * * *"

permissions:
  contents: write        # needed for auto-commit
  pages: write           # needed if you enable GitHub Pages deploy
  id-token: write

concurrency:
  group: "collect-swiftioc"
  cancel-in-progress: false

env:
  ENABLE_PAGES: "true"

jobs:
  collect:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml', 'requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install SwiftIOC
        run: |
          python -m pip install --upgrade pip
          pip install .

      # Optional: supply your own UA list (put file in repo at ./data/user_agents.txt)
      - name: Ensure diagnostics directories
        run: |
          mkdir -p public/diagnostics/raw
          mkdir -p public/iocs
          mkdir -p public/changelog
          if [ ! -f sources.yml ] && [ -f sources.example.yml ]; then
            cp sources.example.yml sources.yml
          fi

      - name: Run collector
        id: run
        env:
          WINDOW_HOURS: ${{ github.event.inputs.window_hours || '48' }}
          URLHAUS_STATUS: ${{ github.event.inputs.urlhaus_status || 'online' }}
        run: |
          set -e
          python -m swiftioc -vv --ci-safe \
            --out-dir public \
            --sources sources.yml \
            --window-hours "$WINDOW_HOURS" \
            --urlhaus-status "$URLHAUS_STATUS" \
            --log-file public/diagnostics/run.log \
            --log-format json \
            --log-file-level DEBUG \
            --save-raw-dir public/diagnostics/raw \
            --diag-json public/diagnostics/run.json \
            --report public/diagnostics/REPORT.md \
            --fail-on-empty urlhaus_recent_urls malwarebazaar_recent

      - name: Summarize IOC outputs
        run: |
          python scripts/summarize_iocs.py \
            --diag public/diagnostics/run.json \
            --ioc-jsonl public/iocs/latest.jsonl \
            --json public/diagnostics/summary.json \
            --out public/diagnostics/summary.md \
            --index public/index.md

      - name: Upload artifacts (diagnostics & outputs)
        uses: actions/upload-artifact@v4
        with:
          name: collect-artifacts-${{ github.run_number }}
          path: |
            public/diagnostics/*
            public/iocs/*
            public/changelog/*
          if-no-files-found: ignore

      - name: Auto-commit updated outputs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ioc): update feeds [skip ci]"
          file_pattern: |
            public/iocs/**
            public/changelog/**
            public/diagnostics/**
          commit_user_name: SwiftIOC Bot
          commit_user_email: actions@github.com
          push_options: "--force-with-lease"

      # --- Optional Pages publish ---
      - name: Upload artifact for GitHub Pages
        if: env.ENABLE_PAGES == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        if: env.ENABLE_PAGES == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
